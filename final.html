<!DOCTYPE html>
<html lang="en">
<head>
   <title>哈利波特电影评分占比</title>
   <script src="https://d3js.org/d3.v7.min.js"></script>
   <style>
      body {
         font-family: Arial, sans-serif;
         background-color: #f4f4f4;
         margin: 0;
         padding: 20px;
      }
      .chart-container {
         width: 90%;
         max-width: 1200px;
         margin: 0 auto;
         background-color: #fff;
         padding: 20px;
         box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }
      .bar {
         transition: opacity 0.3s ease;
      }
      .bar:hover {
         opacity: 0.7;
      }
      .axis-label {
         font-size: 14px;
         fill: #333;
      }
      .legend {
         font-size: 12px;
      }
   </style>
</head>
<body>
   <div class="chart-container">
      <h2>哈利波特电影评分占比</h2>
      <svg width="100%" height="500"></svg>
   </div>

   <script>
      // 电影数据
      const movieData = [
         { name: "哈利·波特与魔法石", ratings: [66.0, 28.1, 5.5, 0.3, 0.1] },
         { name: "哈利·波特与死亡圣器(下)", ratings: [59.9, 31.3, 8.1, 0.6, 0.2] },
         { name: "哈利·波特与阿兹卡班的囚徒", ratings: [57.9, 33.8, 7.8, 0.4, 0.1] },
         { name: "哈利·波特与密室", ratings: [54.1, 36.8, 8.5, 0.4, 0.1] },
         { name: "哈利·波特与混血王子", ratings: [40.7, 38.6, 18.2, 2.1, 0.3] },
         { name: "哈利·波特与火焰杯", ratings: [51.8, 37.8, 9.7, 0.6, 0.1] },
         { name: "哈利·波特与凤凰社", ratings: [44.0, 40.6, 14.2, 1.0, 0.2] },
         { name: "哈利·波特与死亡圣器(上)", ratings: [44.8, 40.5, 13.3, 1.1, 0.3] }
      ];

      // 颜色映射
      const colorScale = d3.scaleOrdinal()
         .domain(["5星", "4星", "3星", "2星", "1星"])
         .range(["#4CAF50", "#8BC34A", "#FFC107", "#FF9800", "#F44336"]);

      // 设置图表尺寸
      const margin = { top: 40, right: 20, bottom: 60, left: 60 };
      const width = 800 - margin.left - margin.right;
      const height = 400 - margin.top - margin.bottom;

      // 创建 SVG 画布
      const svg = d3.select("svg")
         .attr("width", width + margin.left + margin.right)
         .attr("height", height + margin.top + margin.bottom)
         .append("g")
         .attr("transform", `translate(${margin.left},${margin.top})`);

      // 堆叠数据
      const stack = d3.stack()
         .keys(["5星", "4星", "3星", "2星", "1星"])
         .order(d3.stackOrderNone)
         .offset(d3.stackOffsetNone);

      const stackedData = stack(movieData.map(d => ({
         name: d.name,
         "5星": d.ratings[0],
         "4星": d.ratings[1],
         "3星": d.ratings[2],
         "2星": d.ratings[3],
         "1星": d.ratings[4]
      })));

      // 比例尺
      const x = d3.scaleBand()
         .domain(movieData.map(d => d.name))
         .range([0, width])
         .padding(0.2);

      const y = d3.scaleLinear()
         .domain([0, 100])
         .range([height, 0]);

      // 绘制堆叠条形图
      svg.selectAll(".category")
         .data(stackedData)
         .enter().append("g")
         .attr("class", "category")
         .attr("fill", d => colorScale(d.key))
         .selectAll("rect")
         .data(d => d)
         .enter().append("rect")
         .attr("class", "bar")
         .attr("x", d => x(d.data.name))
         .attr("y", d => y(d[1]))
         .attr("height", d => y(d[0]) - y(d[1]))
         .attr("width", x.bandwidth())
         .on("mouseover", (event, d) => {
            const [start, end] = d;
            const rating = d3.select(event.target.parentNode).datum().key;
            const percentage = (end - start).toFixed(1);
            tooltip.transition().duration(200).style("opacity", 0.9);
            tooltip.html(`${rating}: ${percentage}%`)
               .style("left", (event.pageX + 5) + "px")
               .style("top", (event.pageY - 28) + "px");
         })
         .on("mouseout", () => {
            tooltip.transition().duration(500).style("opacity", 0);
         });

      // 添加 X 轴
      svg.append("g")
         .attr("transform", `translate(0,${height})`)
         .call(d3.axisBottom(x))
         .selectAll("text")
         .attr("transform", "rotate(-30)")
         .style("text-anchor", "end");

      // 添加 Y 轴
      svg.append("g")
         .call(d3.axisLeft(y).ticks(5).tickFormat(d => `${d}%`));

      // 添加图例
      const legend = svg.selectAll(".legend")
         .data(colorScale.domain())
         .enter().append("g")
         .attr("class", "legend")
         .attr("transform", (d, i) => `translate(0,${i * 20})`);

      legend.append("rect")
         .attr("x", width - 18)
         .attr("width", 18)
         .attr("height", 18)
         .style("fill", colorScale);

      legend.append("text")
         .attr("x", width - 24)
         .attr("y", 9)
         .attr("dy", ".35em")
         .style("text-anchor", "end")
         .text(d => d);

      // 添加工具提示
      const tooltip = d3.select("body").append("div")
         .attr("class", "tooltip")
         .style("opacity", 0)
         .style("position", "absolute")
         .style("background", "#333")
         .style("color", "#fff")
         .style("padding", "5px")
         .style("border-radius", "3px")
         .style("font-size", "12px");
   </script>
</body>
</html>
